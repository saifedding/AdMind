<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Timing Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .timing { font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <h1>ğŸ” Network Timing Debug</h1>
    <p>This will test the exact same API call that's taking 4 seconds in your browser.</p>
    
    <button onclick="runTest()">ğŸš€ Run Test</button>
    <button onclick="clearResults()">ğŸ—‘ï¸ Clear Results</button>
    
    <div id="results"></div>

    <script>
        let testCount = 0;

        function addResult(message, isError = false, timing = null) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${isError ? 'error' : 'success'}`;
            
            let content = `<strong>Test ${testCount}:</strong> ${message}`;
            if (timing) {
                content += ` <span class="timing">(${timing}ms)</span>`;
            }
            div.innerHTML = content;
            
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testCount = 0;
        }

        async function runTest() {
            testCount++;
            
            const url = "http://localhost:8000/api/v1/ads?page=1&page_size=24&sort_by=created_at&sort_order=desc";
            
            const headers = {
                "accept": "*/*",
                "accept-language": "en-US,en;q=0.9",
                "content-type": "application/json",
                "sec-ch-ua": '"Brave";v="143", "Chromium";v="143", "Not A(Brand)";v="24"',
                "sec-ch-ua-mobile": "?0",
                "sec-ch-ua-platform": '"Windows"',
                "sec-fetch-dest": "empty",
                "sec-fetch-mode": "cors",
                "sec-fetch-site": "same-site",
                "sec-gpc": "1"
            };

            addResult(`Starting request to ${url}...`);
            
            const startTime = performance.now();
            
            try {
                // Use Performance API to get detailed timing
                const observer = new PerformanceObserver((list) => {
                    const entries = list.getEntries();
                    entries.forEach((entry) => {
                        if (entry.name.includes('/api/v1/ads')) {
                            addResult(`ğŸ“Š Performance Timing Breakdown:
                                DNS: ${entry.domainLookupEnd - entry.domainLookupStart}ms
                                Connect: ${entry.connectEnd - entry.connectStart}ms
                                Request: ${entry.requestStart - entry.connectEnd}ms
                                Response: ${entry.responseEnd - entry.responseStart}ms
                                Total: ${entry.responseEnd - entry.requestStart}ms`);
                        }
                    });
                });
                observer.observe({ entryTypes: ['navigation', 'resource'] });

                const response = await fetch(url, {
                    method: 'GET',
                    headers: headers,
                    mode: 'cors',
                    credentials: 'omit'
                });

                const endTime = performance.now();
                const totalTime = Math.round(endTime - startTime);

                if (response.ok) {
                    const data = await response.json();
                    const parseTime = Math.round(performance.now() - endTime);
                    
                    addResult(`âœ… Success! Status: ${response.status}`, false, totalTime);
                    addResult(`ğŸ“¦ Response size: ${JSON.stringify(data).length} characters`);
                    addResult(`ğŸ”¢ Returned ${data.data?.length || 0} ads out of ${data.pagination?.total_items || 0} total`);
                    addResult(`âš¡ JSON parsing took: ${parseTime}ms`);
                    
                    // Check for any obvious performance issues
                    if (totalTime > 2000) {
                        addResult(`ğŸ”´ SLOW: Request took ${totalTime}ms (> 2s)`, true);
                    } else if (totalTime > 1000) {
                        addResult(`ğŸŸ¡ MODERATE: Request took ${totalTime}ms (> 1s)`, true);
                    } else {
                        addResult(`ğŸŸ¢ FAST: Request took ${totalTime}ms (< 1s)`);
                    }
                } else {
                    const errorText = await response.text();
                    addResult(`âŒ HTTP Error: ${response.status} ${response.statusText}`, true, totalTime);
                    addResult(`Error details: ${errorText}`, true);
                }

                observer.disconnect();

            } catch (error) {
                const endTime = performance.now();
                const totalTime = Math.round(endTime - startTime);
                
                addResult(`ğŸ’¥ Network Error: ${error.message}`, true, totalTime);
                
                // Provide debugging suggestions
                if (error.message.includes('Failed to fetch')) {
                    addResult(`ğŸ’¡ Suggestions:
                        â€¢ Check if backend is running: docker ps
                        â€¢ Test direct API: curl http://localhost:8000/api/v1/ads
                        â€¢ Check browser console for CORS errors
                        â€¢ Verify port 8000 is accessible`, true);
                }
            }
        }

        // Auto-run test on page load
        window.addEventListener('load', () => {
            addResult('ğŸŒ Page loaded, ready to test API performance');
        });
    </script>
</body>
</html>