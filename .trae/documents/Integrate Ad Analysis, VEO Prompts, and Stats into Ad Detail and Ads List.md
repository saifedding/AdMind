## Summary of Current Behavior
- `/download-ads` triggers Gemini-based video analysis and stores `generation_prompts`, with history and version loading (frontend/src/app/download-ads/page.tsx:116–197, 149–153, 189–193). 
- `/veo` builds creative briefs and prompt segments via `useVeoGenerator`, supports style analysis, prompt editing, and async video generation (frontend/src/app/veo/page.tsx, useVeoGenerator.ts:235–304, 362–587, 600–680). 
- `/ads` computes and shows stats such as AI analyzed count, average score, and high performers (frontend/src/app/ads/page.tsx:186–203, 385–444).
- Ad detail `/ads/[id]` shows the media carousel and basic metadata (frontend/src/app/ads/[id]/page.tsx).

## Goals
1. Read and reuse `/download-ads` and `/veo` analysis and prompt-generation logic.
2. Add a unified “Analyze Ad” section under each ad detail page (`/ads/[id]`), not a separate page.
3. When analyzing an ad set, auto-pick the best variant based on running days and show the analysis in all set variants.
4. Render image-specific and video-specific analysis fields appropriately (VO/beats only for video).
5. Improve `/ads` stats and merge KPIs: Overall Score, AI Analyzed, Average Score, High Performers (Score > 8.0), and replace any N/A with computed or 0 defaults where reasonable.

## Implementation Outline
### 1) Backend/Analysis Reuse (no new endpoints initially)
- Reuse existing endpoints:
  - `/api/v1/ads/{ad_id}/analyze` for video/image analysis (backend/app/routers/ads.py:2014–2217).
  - `/favorites` endpoints already exist and unaffected.
  - `/settings/ai/veo/*` endpoints for prompt sessions and video generation when needed.
- For image creative analysis: call the same `/analyze` endpoint with a flag `media_type`, rely on existing schema which already supports image analysis; only suppress video-only fields in UI.

### 2) Ad Detail: Analyze Section under Media
- In `frontend/src/app/ads/[id]/page.tsx`, add an “Analyze” section directly under the media.
- UI components:
  - Analyze CTA: `Analyze current ad` and `Analyze ad set` buttons.
  - Status: show analysis version history and a quick selector.
  - Results panels:
    - Summary: Overall Score, Hook Score, Average Score, Performance Rating.
    - For Video: VO transcript summary, beats timeline, key moments, generated prompts list.
    - For Image: single best prompt + textual analysis (headline/body/CTA signals).
  - Actions: “Open in VEO” (prefill with prompts, model selection inferred), “Regenerate” (follow-up).
- Data integration:
  - On “Analyze current ad”, call `/ads/{id}/analyze` and persist result in local state; map fields as per `/download-ads` (page.tsx:141–165).
  - On “Analyze ad set”, fetch variants via `adsApi.getAdsInSet(ad.ad_set_id)`; select best variant:
    - Best variant rule: longest running days based on `start_date` → `end_date` or active duration; fall back to highest `analysis.overall_score` if available.
    - Compute using `differenceInDays` like in ad detail (page.tsx:181–210).
  - After analyzing best variant, render the same Analyze section under all variants (we can persist in local cache keyed by `ad_set_id`).

### 3) Prompt Generation Integration
- Use `/veo` prompt session logic to show prompts generated by analysis:
  - Map `generation_prompts` from `/analyze` to a visible list for video; for image, only top prompt.
  - Provide “Send to VEO” button that opens `/veo` with the prompts preloaded (via query params or local storage).
- Optional: enable brief creation using `adsApi.createVeoSession` for multi-segment generation if the user selects that flow.

### 4) `/ads` Stats Bar Improvements
- Ensure cards render real values and avoid “N/A” by computing:
  - AI Analyzed: count of ads with `analysis` present.
  - Average Score: average of `analysis.overall_score` across analyzed ads; default 0 when none.
  - High Performers: count of ads with `overall_score >= 8.0`.
  - Performance Rating: show banded rating derived from average or distribution (e.g., High/Medium/Low based on thresholds).
- Implementation:
  - Update `fetchAds` aggregation (frontend/src/app/ads/page.tsx:186–203) to compute these robustly with defaults and memoized selectors.
  - Merge KPIs into a unified Stats row component, retaining existing card styles but aligning labels: “Overall Score”, “AI Analyzed”, “Average Score”, “High Performers (Score ≥ 8.0)”.

### 5) Image vs Video Conditional Rendering
- In Analyze section:
  - If `media_type === 'video'` or the selected creative’s media type is Video: render transcript, beats, VO-related fields, and multi-prompt list.
  - If Image: render textual insights and the single best prompt; hide VO/beats components.
- Guard components so fields that are missing are safely hidden or show a compact “no data” note.

### 6) UX Details
- Place Analyze section immediately below the media frame in `/ads/[id]` for continuity.
- Maintain consistent styling using existing `Card`, `Badge`, and `Button` components.
- Provide a small inline loader and non-blocking alerts for long operations (analysis, fetch variants).
- Persist last analysis in component state and optionally in local storage to avoid re-running on navigation.

### 7) Validation & Performance
- Validate with:
  - One video ad and one image ad.
  - One ad set with multiple variants and different durations to verify best-variant selection.
  - Stats panel correctness on `/ads` with mixed analyzed/un-analyzed ads.
- Avoid heavy recomputations by memoizing stats and caching analysis results.

### 8) Rollout
- Ship UI changes on `/ads/[id]` and `/ads` pages first.
- Defer deeper VEO session creation enhancements until baseline Analyze section works and is validated.

## Deliverables
- Enhanced Analyze section under `/ads/[id]` with conditional video/image fields and action buttons.
- Best-variant selection by running days on “Analyze ad set”, mirrored across set members.
- Updated `/ads` Stats bar with merged KPIs and non-N/A values.
- Prompt list integration and “Open in VEO” bridge.

## Notes
- All changes reuse existing endpoints; no backend migrations required.
- If the `generation_prompts` schema has differences between image/video, handle defensively with optional chaining and empty-state UI.
- We will align thresholds (e.g., 8.0 for High Performers) with existing usage in `/ads`.